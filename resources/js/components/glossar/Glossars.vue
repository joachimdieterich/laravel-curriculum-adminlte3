<template>
    <div class="card">
        <div class="card-header px-3">
            <h3 class="card-title">
                <span
                    data-target="#glossarCarousel"
                    data-slide-to="0"
                    class="text-sm"
                >
                    <i class="fa fa-list"></i>
                </span>
                <span v-if="currentSlide == 0"
                    class="pl-2"
                >
                    Glossar-Index
                </span>
                <span v-else
                    class="pl-2"
                >
                    {{ subscriptions[currentSlide-1].content.title }}
                </span>
            </h3>

            <div class="card-tools">
                <button
                    v-permission="'glossar_delete'"
                    class="btn btn-tool text-danger"
                    @click.prevent="deleteGlossar()"
                >
                    <i class="fa fa-trash "></i>
                </button>
                <button
                    v-permission="subscribable_type + '_content_create'"
                    class="btn btn-tool"
                    @click="show()"
                >
                    <i class="fa fa-plus"></i>
                </button>
                <button
                    class="btn btn-tool draggable"
                    href="#glossarCarousel"
                    data-slide="prev"
                    @click="prev()"
                >
                    <i class="fa fa-arrow-left"></i>
                </button>
                <button
                    class="btn btn-tool draggable"
                    href="#glossarCarousel"
                    data-slide="next"
                    @click="next()"
                >
                    <i class="fa fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div class="card-glossar">
            <div
                id="glossarCarousel"
                class="carousel slide"
                data-interval="false"
            >
                <ol class="carousel-indicators pt-3">
                    <li
                        data-target="#glossarCarousel"
                        data-slide-to="0"
                        class="active"
                        @click="setSlide(0)"
                    ></li>
                    <li v-for="(item,index) in subscriptions"
                        tooldata-toggle="tooltip"
                        data-placement="top"
                        :title="item.content.title"
                        data-target="#glossarCarousel"
                        :data-slide-to="index + 1"
                        @click="setSlide(index + 1)"
                    ></li>
                </ol>

                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <ul class="list-unstyled p-3" title="Index">
                            <span v-for="(item,index) in subscriptions">
                                <li class="pb-2">
                                    <span class="pointer">
                                        <span
                                            data-target="#glossarCarousel"
                                            :data-slide-to="index + 1"
                                            @click="setSlide(index + 1)"
                                        >
                                            {{ item.content.title }}
                                        </span>
                                        <span
                                            v-permission="'content_delete, ' + subscribable_type + '_content_delete'"
                                            class="pull-right"
                                        >
                                            <span
                                                class="btn-tool fa fa-trash text-danger"
                                                @click.prevent="deleteSubscription(item)"
                                            ></span>
                                        </span>
                                        <br>
                                        <small
                                            class="text-muted"
                                            v-dompurify-html="item.content.content">
                                        </small>
                                    </span>
                                </li>
                            </span>
                        </ul>
                    </div>

                    <div v-for="(item,index) in subscriptions"
                        class="carousel-item"
                        :title="item.content.title"
                    >
                        <div class="p-3" v-html="item.content.content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
import {useGlobalStore} from "../../store/global";

export default {
    props: {
        subscribable_type: {
            type: String,
            default: null,
        },
        subscription: {
            type: Object,
            default: null,
        },
        glossar: {
            type: Object,
            default: null,
        },
    },
    setup() {
        const globalStore = useGlobalStore();
        return {
            globalStore,
        }
    },
    data() {
        return {
            subscriptions: {},
            errors: {},
            currentSlide: 0,
        }
    },
    methods: {
        show() {
            this.globalStore?.showModal('content-modal',{
                subscribable_type: 'App\\Glossar',
                subscribable_id: this.glossar.id,
            });
        },
        setSlide(id) {
            this.currentSlide = id;
        },
        prev() {
            if (this.currentSlide === 0) {
                this.currentSlide = this.subscriptions.length;
            } else {
                this.currentSlide--;
            }
        },
        next() {
            if (this.currentSlide == this.subscriptions.length) {
                this.currentSlide = 0;
            } else {
                this.currentSlide++;
            }
        },
        deleteSubscription(contentSubscription) {
            try {
                axios.post('/contents/' + contentSubscription.content_id + '/destroy', {
                    subscribable_type: contentSubscription.subscribable_type,
                    subscribable_id: contentSubscription.subscribable_id,
                }).then(response => {
                    let index = this.subscriptions.indexOf(contentSubscription);
                    this.subscriptions.splice(index, 1);
                });
            } catch(e) {
                console.log(e);
            }
        },
        async deleteGlossar() {
            if (confirm(this.trans('global.areYouSure'))) {
                try {
                    await axios.delete('/glossar/' + this.glossar.id);
                } catch (error) {
                    this.errors = error.response.data.errors;
                }
                location.reload();
            }
        },
        loaderEvent() {
            axios.get('/glossar/' + this.glossar.id)
                .then(response => {
                    this.subscriptions = response.data;
                })
                .catch(e => {
                    this.errors = error.response.data.errors;
                });
        },
    },
    beforeMount() {
        this.loaderEvent();
    },
    mounted() {
        this.currentSlide = 0;
        this.$eventHub.on('content-added', (content) => {
            this.subscriptions.push(content);
        });
    },
}
</script>